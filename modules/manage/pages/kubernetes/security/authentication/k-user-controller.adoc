= Manage Users with the Redpanda Operator
:description: Use the User resource to declaratively create and manage Kafka users as part of a Redpanda deployment. Each User resource is mapped to a user in your Redpanda cluster. The user controller keeps the corresponding Kafka user in sync with the User resource.
:page-categories: Management, Development
:env-kubernetes: true

The Redpanda Operator allows you to declaratively create and manage Kafka users using xref:reference:k-crd.adoc[User custom resources] in Kubernetes. Each User resource is mapped to a user in your Redpanda cluster. The user controller, a component of the Redpanda Operator, keeps the corresponding Kafka user in sync with the User resource. This resource allows you to create users as part of a Redpanda deployment.

== Prerequisites

You must have the following:

* *Kubernetes cluster*: Ensure you have a running Kubernetes cluster, either locally (minikube or kind) or remotely.
* *Kubectl*: Ensure you have the https://kubernetes.io/docs/tasks/tools/#kubectl[kubectl^] command-line tool installed and configured to communicate with your cluster.
* *Redpanda Operator*: Ensure you have the xref:deploy:deployment-option/self-hosted/kubernetes/k-production-deployment.adoc[Redpanda Operator].
* *Redpanda cluster with SASL enabled*: Ensure you have a Redpanda resource deployed with xref:manage:kubernetes/security/authentication/k-authentication.adoc#enable[SASL authentication enabled].

== Create a user

You can create a new user using a User resource:

.`new-user.yaml`
[,yaml]
----
include::manage:example$kubernetes/user.feature[tags=manage-authn-only-manifest,indent=0]
----

== Create an access control list (ACL)

You can create a new ACL for existing users in your cluster using the User resource. Give the User resource the same name as your existing user.

.`new-acl.yaml`
[,yaml]
----
include::manage:example$kubernetes/user.feature[tags=manage-authz-only-manifest,indent=0]
----

=== Specify authentication type

You can specify the authentication type for a user using the `spec.authentication.type` field. Supported values include `scram-sha-256`, `scram-sha-512`, and their uppercase variants.

[,yaml]
----
spec:
  authentication:
    type: scram-sha-512
----

If no authentication credentials are provided, no user will be created, but ACLs can still be managed for existing users.

=== Manage user secrets

Redpanda users require a password, which can be provided directly, using the `spec.password.value` field, or through a Kubernetes Secret, using the `spec.password.valueFrom.secretKeyRef`.

For example, to use a Kubernetes Secret for the password, ensure the secret exists and reference it like so:

[source,yaml]
----
spec:
  authentication:
    password:
      valueFrom:
        secretKeyRef:
          name: user-secret
          key: password
----

To create the Secret:

[,bash]
----
kubectl --namespace <namespace> create secret generic user-secret--from-file=password.txt
----

.Example Kubernetes Secret for the user password
[source,yaml]
----
apiVersion: v1
kind: Secret
metadata:
  name: user-secret
type: Opaque
data:
  # base64-encoded password
  password: cGFzc3dvcmQ=
----

== Deploy a User resource

To deploy a User resource, apply the manifest to the same namespace as your Redpanda cluster:

[bash]
----
kubectl apply -f <manifest-filename>.yaml --namespace <namespace>
----

- Replace `<manifest-filename>` with the filename of your manifest.
- Replace `<namespace>` with the namespace in which you deployed Redpanda.

== Verify a user

After deploying a User resource, verify that the Redpanda Operator reconciled it:

[bash]
----
kubectl logs -l app.kubernetes.io/name=operator -c manager --namespace <namespace>
----

Example output:

[source,json]
----
{
  "level": "info",
  "ts": "2024-09-25T16:20:09.538Z",
  "logger": "UserReconciler.Reconcile",
  "msg": "Starting reconcile loop",
  "controller": "user",
  "User": {
    "name": "my-user",
    "namespace": "<namespace>"
  },
  "reconcileID": "c0cf9abc-a553-48b7-9b6e-2de3cdfb4432"
}
{
  "level": "info",
  "ts": "2024-09-25T16:20:09.581Z",
  "logger": "UserReconciler.Reconcile",
  "msg": "Reconciliation finished in 43.436125ms, next run in 3s",
}
----

== Update a user

To update a user, edit the User resource configuration and apply the changes.

For example, to change the authentication method:

.`updated-user.yaml`
[source,yaml]
----
apiVersion: cluster.redpanda.com/v1alpha2
kind: User
metadata:
  name: my-user
spec:
  authentication:
    type: scram-sha-256
  cluster:
    clusterRef:
      name: redpanda-cluster
----

Apply the changes:

[bash]
----
kubectl apply -f updated-user.yaml --namespace <namespace>
----

== Delete a user

To delete a user, delete the User resource:

[bash]
----
kubectl delete -f example-user.yaml --namespace <namespace>
----

When a user is deleted, its underlying data is removed as well. If the user has ACLs, those ACLs are also removed.

== Suggested reading

* xref:reference:k-crd.adoc[]
* xref:manage:kubernetes/security/authentication/k-authentication.adoc[]